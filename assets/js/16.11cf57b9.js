(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{1051:function(s,i,t){"use strict";t.r(i);var e=t(11),_=Object(e.a)({},(function(){var s=this,i=s._self._c;return i("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[i("p",[s._v("bili-sync 是一款专为 NAS 用户编写的哔哩哔哩同步工具。它的基本的工作原理是使用用户填写的凭据定期扫描视频合集、收藏夹等，获取到本地未下载过的内容并保存到本地，维持本地视频库与哔哩哔哩网站的同步。")]),s._v(" "),i("p",[s._v("官网：https://bili-sync.allwens.work/quick-start")]),s._v(" "),i("p",[s._v("注意：自 2.6.0 版本开始是数据库形式，本文教程版本为2.9.4")]),s._v(" "),i("h2",{attrs:{id:"compose部署"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#compose部署"}},[s._v("#")]),s._v(" compose部署")]),s._v(" "),i("div",{staticClass:"language- line-numbers-mode"},[i("pre",{pre:!0,attrs:{class:"language-text"}},[i("code",[s._v("services:\n  bili-sync-rs:\n    image: amtoaer/bili-sync-rs:latest\n    hostname: bili-sync-rs\n    container_name: bili-sync-rs\n    restart: unless-stopped\n    network_mode: bridge\n    tty: true # 该选项请仅在日志终端支持彩色输出时启用，否则日志中可能会出现乱码\n    # user: 1000:1000 # 不设置默认为 Root\n    ports:\n      - 12345:12345\n    volumes:\n      - ./config:/app/.config/bili-sync # 配置目录\n      - /volume5/Media_other/BiliSync:/media # 视频保存目录\n      # - ${Emby 或 Jellyfin 配置下的 metadata/people 目录}:/app/.config/bili-sync/upper_face # metadata/people 正确挂载才能在 Emby 或 Jellyfin 中显示 UP 主头像。右边的目标目录不固定，只需要确保目标目录与 bili-sync 中填写的“UP 主头像保存路径”保持一致即可\n")])]),s._v(" "),i("div",{staticClass:"line-numbers-wrapper"},[i("span",{staticClass:"line-number"},[s._v("1")]),i("br"),i("span",{staticClass:"line-number"},[s._v("2")]),i("br"),i("span",{staticClass:"line-number"},[s._v("3")]),i("br"),i("span",{staticClass:"line-number"},[s._v("4")]),i("br"),i("span",{staticClass:"line-number"},[s._v("5")]),i("br"),i("span",{staticClass:"line-number"},[s._v("6")]),i("br"),i("span",{staticClass:"line-number"},[s._v("7")]),i("br"),i("span",{staticClass:"line-number"},[s._v("8")]),i("br"),i("span",{staticClass:"line-number"},[s._v("9")]),i("br"),i("span",{staticClass:"line-number"},[s._v("10")]),i("br"),i("span",{staticClass:"line-number"},[s._v("11")]),i("br"),i("span",{staticClass:"line-number"},[s._v("12")]),i("br"),i("span",{staticClass:"line-number"},[s._v("13")]),i("br"),i("span",{staticClass:"line-number"},[s._v("14")]),i("br"),i("span",{staticClass:"line-number"},[s._v("15")]),i("br")])]),i("p",[s._v("如果设置了user，但是容器一直在重启，查看日志显示："),i("code",[s._v("数据库初始化失败: Failed to migrate database")]),s._v("的话，说明权限不够，建议注释或者删除user一行，用默认的root。")]),s._v(" "),i("p",[s._v("容器启动成功后获取日志里的auth_token：")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(679),alt:"img"}})]),s._v(" "),i("p",[s._v("如果是第一次部署时没记录下来，后面又重新部署容器把日志刷掉了，可以停掉 bili-sync 后用 DB Browser for SQLite 或类似的工具打开 data.sqlite，config 表里存储了 json 格式的配置信息。如果config表里面没有信息的话可以试试删除这个表重新启动容器。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(680),alt:"img"}})]),s._v(" "),i("h2",{attrs:{id:"认证配置"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#认证配置"}},[s._v("#")]),s._v(" 认证配置")]),s._v(" "),i("p",[s._v("1、浏览器输入IP:12345，打开 WebUI。")]),s._v(" "),i("p",[s._v("2、此时有个提示弹窗说未认证不用管他，我们点击左下角的设置，把刚刚在日志里的token填入输入框然后点击认证。点击完成后状态会变成已认证。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(681),alt:"img"}})]),s._v(" "),i("p",[s._v("3、B 站认证")]),s._v(" "),i("p",[s._v("认证后设置页面会出现更多设置栏目，我们来到B站认证菜单，填写所需的五个值然后点击保存设置。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(682),alt:"img"}})]),s._v(" "),i("p",[s._v("其中ac_time_valueac_time_value 用于刷新凭据，如果不填写或填写错误，那么 credential 没办法自动更新，过几天就会失效。需要按 F12 打开开发者工具，然后进入控制台，输入"),i("code",[s._v("window.localStorage.ac_time_value")]),s._v("即可获取值。如果输入后结果是undefined，可以尝试：")]),s._v(" "),i("ul",[i("li",[s._v("退出重新登录")]),s._v(" "),i("li",[s._v("使用无痕模式")]),s._v(" "),i("li",[s._v("更换浏览器")]),s._v(" "),i("li",[s._v("多退出登录几次")])]),s._v(" "),i("p",[s._v("我个人是edge和谷歌的正常和无痕都不行，也都试了一次重新登录也不行，后来在无痕模式下再退出重新登了一次才行的。\n​"),i("img",{attrs:{src:t(683),alt:"img"}})]),s._v(" "),i("p",[s._v("剩下的sessdata、bili_jct、buvid3 和 dedeuserid 这四个参数的值均在浏览器的 Cookies 里头，获取方法：")]),s._v(" "),i("ul",[i("li",[s._v("按 F12 打开开发者工具")]),s._v(" "),i("li",[s._v("在工具窗口上方找到"),i("code",[s._v("应用程序")]),s._v("选项卡")]),s._v(" "),i("li",[s._v("在左侧找到"),i("code",[s._v("存储/Cookies")]),s._v("，并选中b站域名，在右侧找到对应四项即可。")])]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(684),alt:"img"}})]),s._v(" "),i("h2",{attrs:{id:"下载视频"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#下载视频"}},[s._v("#")]),s._v(" 下载视频")]),s._v(" "),i("p",[s._v("点击我创建的收藏夹菜单，可以看到所有的收藏夹，点击订阅按钮可以订阅此收藏夹，注意本地保存路径得设置对，比如我的compose里挂载的下载目录为media，则我这里是"),i("code",[s._v("/media/运动")]),s._v("。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(685),alt:"img"}})]),s._v(" "),i("blockquote",[i("p",[s._v("这里因为有很多人不理解导致下了视频后找不到，我再多说明一下。")]),s._v(" "),i("p",[s._v("首先看我们compose里挂载的视频保存目录 "),i("code",[s._v("- /volume5/Media_other/BiliSync:/media # 视频保存目录")]),s._v(" ：")]),s._v(" "),i("ul",[i("li",[s._v("冒号左边："),i("code",[s._v("/volume5/Media_other/BiliSync")]),s._v(" 是你的绿联 NAS 本地"),i("strong",[s._v("实际路径")]),s._v("，这个路径可以右键对应文件夹→属性查看复制，是视频文件最终实际保存的位置；")]),s._v(" "),i("li",[s._v("冒号右边：/media 是容器内部的"),i("strong",[s._v("挂载映射路径")]),s._v("，可自定义为 /download 或者 /save 等任意名称，只要使用的时候保持一致即可。")])]),s._v(" "),i("p",[i("strong",[s._v("保存路径设置规则")]),s._v("：")]),s._v(" "),i("p",[s._v("容器会通过冒号右侧的容器挂载路径，映射到 NAS 本地的实际路径，所以在容器的视频保存设置中，保存路径必须以容器挂载路径为前缀（或直接填容器挂载路径）：")]),s._v(" "),i("ul",[i("li",[s._v("直接保存到 NAS 实际路径根目录：保存路径填 /media（根据你冒号右边的挂载路径来填写）；")]),s._v(" "),i("li",[s._v("保存到 NAS 实际路径的二级目录：在容器挂载路径后加后缀即可，比如我要保存到运动分类，就填 "),i("code",[s._v("/media/运动")]),s._v("，文件最终会出现在 NAS 的"),i("code",[s._v("/volume5/Media_other/BiliSync/运动")]),s._v(" 文件夹下。")])]),s._v(" "),i("p",[s._v("简单说：NAS 实际路径负责 【文件存在哪】，容器挂载路径负责【容器认哪】，保存路径得跟着容器挂载路径填。")]),s._v(" "),i("p",[s._v("不小心设置错了保存路径：\n​"),i("img",{attrs:{src:t(686),alt:"img"}})])]),s._v(" "),i("p",[s._v("订阅完成后可以在视频源菜单看到运动这个名称，也可以点击手动添加的按钮来添加收藏夹，只是需要填写收藏夹id。其他类型的视频源类似。")]),s._v(" "),i("blockquote",[i("p",[s._v("注意：使用快捷订阅添加视频源后"),i("strong",[s._v("默认不启用")]),s._v("，需要手动点击编辑后进去开启，开启的与否就是看启用状态列的滑动按钮是否在右边。如果源都没有开启，会遇到如下错误："),i("strong",[s._v("本轮视频下载任务执行遇到错误：没有可用的视频源")]),s._v("。")])]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(687),alt:"img"}})]),s._v(" "),i("p",[s._v("点击编辑按钮进入编辑页面，可以选择开启还是关闭这个源，或者设置过滤规则。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(688),alt:"img"}})]),s._v(" "),i("p",[s._v("启用的视频源里的视频下载任务会在后台每隔特定时间自动运行一次，由配置中的“任务触发条件”决定。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(689),alt:"img"}})]),s._v(" "),i("p",[s._v("也可以点击首页的立即执行下载任务手动下载启用的视频源里的任务。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(690),alt:"img"}})]),s._v(" "),i("p",[s._v("在视频菜单下也可以看到所有下载的视频。")]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(691),alt:"img"}})]),s._v(" "),i("p",[s._v("可以点击日志菜单查看情况。")]),s._v(" "),i("blockquote",[i("p",[s._v("如果下载的时候报错"),i("code",[s._v("message: 账号未登录")]),s._v("，而且B站认证里的内容确认填写正确的话，建议重启一下容器看看。")])]),s._v(" "),i("p",[s._v("​"),i("img",{attrs:{src:t(692),alt:"img"}})]),s._v(" "),i("h2",{attrs:{id:"常见问题"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#常见问题"}},[s._v("#")]),s._v(" 常见问题")]),s._v(" "),i("p",[s._v("1、错误：request failed, status code: -352, message: -352，等待下一轮执行")]),s._v(" "),i("p",[s._v("这个是风控导致的。当前程序已经采取了多种措施缓解风控，包括：")]),s._v(" "),i("ul",[i("li",[s._v("除合集外的视频源类型基于时间提前中断；")]),s._v(" "),i("li",[s._v("视频详情仅填充一次、下载结果记录到数据库中，在下一轮执行时跳过；")]),s._v(" "),i("li",[s._v("支持配置并发限制、请求频率限制；")]),s._v(" "),i("li",[s._v("遇到风控自动中断等待下一轮执行；")]),s._v(" "),i("li",[s._v("每轮任务前打乱视频源顺序，避免后续视频源长期饥饿。")]),s._v(" "),i("li",[s._v("目前风控应该主要出现在添加新视频源后，新增大量视频需要处理导致风控的触发频率较高。存量视频处理差不多后，每轮仅检测处理新增视频应该不太会触发风控。如果还是遇到风控比较多可以尝试调低并发和请求频率限制。")])]),s._v(" "),i("p",[s._v("不过当前程序已经有了比较完善的风控处理逻辑了，极端点来讲，即使每轮任务都触发风控，从宏观角度来看问题规模也是在逐步下降的。因此风控并不是需要修复的 BUG，可以视作一个不影响程序正确性的 WARNING。")]),s._v(" "),i("p",[s._v("另外风控主要出现在下载存量视频时，等存量视频填充完毕后，每个周期扫描写入的新视频数量级不会很大，一般不会触发风控。")]),s._v(" "),i("p",[s._v("说到底风控是由 b 站服务器策略导致的，bili-sync 作为接口调用方除了限流和完善处理策略外能做的十分有限。")]),s._v(" "),i("p",[s._v("2、检查刷新 Credential 遇到错误")]),s._v(" "),i("ul",[i("li",[i("code",[s._v("status code: -111")]),s._v(": cookie 里的 bili_jct 字段")]),s._v(" "),i("li",[i("code",[s._v("status code: 86095")]),s._v(": ac_time_value 字段")])]),s._v(" "),i("p",[s._v("程序的 cookie 刷新机制按照"),i("a",{attrs:{href:"https://github.com/SocialSisterYi/bilibili-API-collect/blob/15b325637cd6226825d7afe6c628845a895bcc94/docs/login/cookie_refresh.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("上游文档"),i("OutboundLink")],1),s._v("实现，会在每天第一次执行扫描任务时检查刷新，如果 b 站 api 返回“需要刷新”则进入刷新 cookie 流程。")]),s._v(" "),i("p",[s._v("这类问题最简单的解决办法就是重新填一遍凭据，推荐的方法是开启浏览器无痕窗口登录，获取一套凭据后填写到 bili-sync。")])])}),[],!1,null,null,null);i.default=_.exports},679:function(s,i,t){s.exports=t.p+"assets/img/bili-01.0aef6501.png"},680:function(s,i,t){s.exports=t.p+"assets/img/bili-13.69f75275.png"},681:function(s,i,t){s.exports=t.p+"assets/img/bili-02.5c326c2f.png"},682:function(s,i,t){s.exports=t.p+"assets/img/bili-03.93252b8d.png"},683:function(s,i,t){s.exports=t.p+"assets/img/bili-05.77104752.png"},684:function(s,i,t){s.exports=t.p+"assets/img/bili-04.56e74b3c.png"},685:function(s,i,t){s.exports=t.p+"assets/img/bili-06.8e735612.png"},686:function(s,i,t){s.exports=t.p+"assets/img/bili-14.0cd7e9aa.png"},687:function(s,i,t){s.exports=t.p+"assets/img/bili-07.66d95a04.png"},688:function(s,i,t){s.exports=t.p+"assets/img/bili-08.c2b86697.png"},689:function(s,i,t){s.exports=t.p+"assets/img/bili-11.a7989725.png"},690:function(s,i,t){s.exports=t.p+"assets/img/bili-12.0b8b79e4.png"},691:function(s,i,t){s.exports=t.p+"assets/img/bili-09.48d3b339.png"},692:function(s,i,t){s.exports=t.p+"assets/img/bili-10.45948de7.png"}}]);