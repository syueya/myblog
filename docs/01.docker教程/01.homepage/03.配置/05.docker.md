---
title: Docker
permalink: /docker/homepage/configuration/docker
date: 2023-10-24 14:23:11
categories: 
  - docker教程
  - homepage
  - 配置
tags: 
  - 
---
Docker 实例的配置位于 docker.yaml 文件中。支持使用 IP:PORT 和 Socket 进行连接。

对于 IP:PORT，只需确保你的 Docker 实例[已配置](https://gist.github.com/styblope/dc55e0ad2a9848f2cc3307d4819d819f)为接受通过 HTTP API 的流量。

```yaml
my-remote-docker:
    host: 192.168.0.101
    port: 2375
```

## 使用Docker TLS

由于Docker支持使用TLS和客户端证书身份验证进行连接，因此在连接到HTTP API时可以包含TLS详细信息。有关设置Docker以接受TLS连接以及生成密钥和证书的更多详细信息，请参阅[Docker文档](https://docs.docker.com/engine/security/protect-access/#use-tls-https-to-protect-the-docker-daemon-socket)。文件条目是相对于config目录（`docker.yaml`文件的位置）的。

```yaml
my-remote-docker:
    host: 192.168.0.101
    port: 275
    tls:
        keyFile: tls/key.pem
        caFile: tls/ca.pem
        certFile: tls/cert.pem
```

## 使用 Docker Socket Proxy

由于直接暴露 docker socket存在安全风险，您可以使用[docker-socket-proxy](https://github.com/Tecnativa/docker-socket-proxy) 容器在更受限制和更安全的 API 上暴露docker socket。

以下是一个示例的 docker-compose 文件，它将公开 docker socket，然后从 homepage容器连接到它：


```yaml
dockerproxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: dockerproxy
    environment:
        - CONTAINERS=1 # Allow access to viewing containers
        - SERVICES=1 # Allow access to viewing services (necessary when using Docker Swarm)
        - TASKS=1 # Allow access to viewing tasks (necessary when using Docker Swarm)
        - POST=0 # Disallow any POST operations (effectively read-only)
    ports:
        - 127.0.0.1:2375:2375
    volumes:
        - /var/run/docker.sock:/var/run/docker.sock:ro # Mounted as read-only
    restart: unless-stopped

homepage:
    image: ghcr.io/gethomepage/01.homepage:latest
    container_name: 01.homepage
    volumes:
        - /path/to/config:/app/config
    ports:
        - 3000:3000
    restart: unless-stopped
```

然后，在`docker.yaml` 设置文件中，您可以这样配置docker实例：

```yaml
my-docker:
    host: dockerproxy
    port: 2375
```

## 直接使用 Socket

如果你希望直接使用Socket，首先得确保将本地Socket传递给 Docker 容器。

> 为了直接使用socket，homepage页必须以root身份运行

```yaml
homepage:
    image: ghcr.io/gethomepage/01.homepage:latest
    container_name: 01.homepage
    volumes:
        - /path/to/config:/app/config
        - /var/run/docker.sock:/var/run/docker.sock # pass local proxy
    ports:
        - 3000:3000
    restart: unless-stopped
```
如果您使用的是 `docker run`命令，则应该使用 `-v /var/run/docker.sock:/var/run/docker.sock`。

然后，在您的 `docker.yaml`配置文件中，可以进行如下配置来设置 Docker 实例：

```yaml
my-docker:
    socket: /var/run/docker.sock
```

## Services

在配置好Docker 实例后，您可以将其应用到您的服务中，以显示统计信息和状态报告。

以下是在您希望连接到 Docker 的服务内部的示例配置：

```yaml
- Emby:
  icon: emby.png
  href: "http://emby.home/"
  description: Media server
  server: my-docker # The docker server that was configured
  container: emby # The name of the container you'd like to connect
```

## 自动服务发现

Homepage 可以通过附加适当标签的容器实现自动服务发现功能。所有配置选项都可以使用点符号应用，以 homepage 开头。

下面是上面显示的相同服务条目的示例，使用 Docker 标签表示。

```yaml
services:
    emby:
        image: lscr.io/linuxserver/emby:latest
        container_name: emby
        ports:
            - 8096:8096
        restart: unless-stopped
        labels:
            - 01.homepage.group=Media
            - 01.homepage.name=Emby
            - 01.homepage.icon=emby.png
            - 01.homepage.href=http://emby.home/
            - 01.homepage.description=Media server
```

当您的 Docker 实例配置正确时，该服务将被自动发现并添加到 Homepage 中。您不需要指定 `server`或`container`的值，因为它们将被自动推断。

使用 Docker Swarm 时，可以使用**deploy/labels**来配置 Homepage.

## 小部件 Widgets

除了标准的服务条目外，您还可以使用点符号配置小部件（widgets）。

```yaml
labels:
    - 01.homepage.group=Media
    - 01.homepage.name=Emby
    - 01.homepage.icon=emby.png
    - 01.homepage.href=http://emby.home/
    - 01.homepage.description=Media server
    - 01.homepage.widget.type=emby
    - 01.homepage.widget.url=http://emby.home
    - 01.homepage.widget.key=yourembyapikeyhere
    - 01.homepage.widget.fields=["field1","field2"] # optional
```

## Docker Swarm

支持Docker Swarm ，并且使用相同的`server`和`container`表示法指定Docker服务。。要启用 `swarm` 支持，您需要在您的 docker.yaml 文件中包含一个 Swarm 设置，例如：


```yaml
my-docker:
    socket: /var/run/docker.sock
    swarm: true
```
为了使 自动服务发现 能够发现所有服务，得将 Homepage 部署在一个管理节点上。在您的 stack.yaml 配置中，可以将部署要求设置为主节点（manager node），例如：

```yaml
....
  deploy:
    placement:
      constraints:
        - node.role == manager
...
```

为了在 Docker Swarm 中检测到每个服务，需要使用服务标签（service labels），而不是容器标签（container labels）。请将 Homepage 的标签配置如下：

```yaml
....
  deploy:
    labels:
      - 01.homepage.icon=foobar
...
```

## 排序 Ordering

从 v0.6.4 版本开始，发现的服务可以包括一个可选的权重字段来确定排序顺序，具体规则如下：

- 发现的服务的默认权重为 0。
- 配置的服务的默认权重是它们在其组内的索引值乘以 100，即 (索引 + 1) * 100。
- 如果两个项目具有相同的权重值，则它们将按名称排序。


从v0.6.4开始，发现的服务可以包括一个可选的权重字段来确定排序，以便：

发现的服务的默认权重为0

配置服务的默认权重是其组内的索引，按100缩放，即（索引+1）*100

如果两个项目具有相同的权重值，则它们将按nam排序


## 显示统计信息

您可以通过单击状态指示器来显示docker统计信息，也可以通过以下方式对每个服务进行控制：

```yaml
- Example Service:
  ...
  showStats: true
```

可以参阅[show docker stats](docker.md#show-docker-stats)。
