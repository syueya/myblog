---
title: Kubernetes
permalink: /docker/homepage/configuration/kubernetes
date: 2023-10-24 14:23:11
categories: 
  - docker教程
  - homepage
  - 配置
tags: 
  - 
---

Kubernetes连接具有以下要求：

-   Kubernetes 版本 1.19+
-   Metrics 服务
-   Ingress 控制器

Kubernetes连接是在Kubernetes.yaml文件中配置的。有三种模式可供选择：

- disabled - 禁用 Kubernetes 连接功能
- default - 使用默认的 kubeconfig 配置文件解析
c- luster - 在集群中使用服务账户进行连接


```yaml
mode: default
```

## 服务 Services

一旦配置了Kubernetes连接，就可以配置各个服务来获取统计信息。当前仅支持CPU和内存。

在你想要连接到pod的服务内部：

```yaml
- Emby:
  icon: emby.png
  href: "http://emby.home/"
  description: Media server
  namespace: media # The kubernetes namespace the app resides in
  app: emby # The name of the deployed app
```

`app`字段用于创建标签选择器，例如，在本例中，它将匹配具有标签 app.kubernetes.io/name=emby 的 Pod。 然而在复杂或非典型的应用部署中，这可能是不够的。

在这种情况下，可以使用 pod-selector 字段，任何字段选择器都可以与它一起使用，因此它可以提供一些非常强大的选择能力。

例如，可以利用它将多个底层部署归类到一个应用程序下，从而查看高级别的聚合信息：

```yaml
- Element Chat:
      icon: matrix-light.png
      href: https://chat.example.com
      description: Matrix Synapse Powered Chat
      app: matrix-element
      namespace: comms
      pod-selector: >-
          app.kubernetes.io/instance in (
              matrix-element,
              matrix-media-repo,
              matrix-media-repo-postgresql,
              matrix-synapse
          )
```

> 将 pod-selector 设置为空字符串并不会将其禁用，实际上它将选择命名空间中的所有 Pod。这是一种捕获单个命名空间中复杂应用（如 Longhorn）的资源使用情况的有用方法。

## 自动服务发现

Homepage功能支持通过 Ingress 注解进行自动服务发现。所有配置选项都可以使用典型的注解语法来应用，以`gethomepage.dev/`开头。

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: emby
    annotations:
        gethomepage.dev/enabled: "true"
        gethomepage.dev/description: Media Server
        gethomepage.dev/group: Media
        gethomepage.dev/icon: emby.png
        gethomepage.dev/name: Emby
        gethomepage.dev/widget.type: "emby"
        gethomepage.dev/widget.url: "https://emby.example.com"
        gethomepage.dev/pod-selector: ""
        gethomepage.dev/weight: 10 # optional
spec:
    rules:
        - host: emby.example.com
          http:
              paths:
                  - backend:
                        service:
                            name: emby
                            port:
                                number: 8080
                    path: /
                    pathType: Prefix
```
当Kubernetes集群连接配置正确后，此服务将自动被发现并添加到您的主页中。您不需要指定`namespace`或`app`，因为它们将自动推断出来。


### Traefik IngressRoute支持

Homepage还可以读取使用 Traefik IngressRoute 自定义资源定义定义的 Ingress。由于 Traefik 路由规则的复杂性，需要设置`gethomepage.dev/href`注解。

```yaml
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
    name: emby
    annotations:
        gethomepage.dev/href: "https://emby.example.com"
        gethomepage.dev/enabled: "true"
        gethomepage.dev/description: Media Server
        gethomepage.dev/group: Media
        gethomepage.dev/icon: emby.png
        gethomepage.dev/name: Emby
        gethomepage.dev/widget.type: "emby"
        gethomepage.dev/widget.url: "https://emby.example.com"
        gethomepage.dev/pod-selector: ""
        gethomepage.dev/weight: 10 # optional
spec:
    entryPoints:
        - websecure
    routes:
        - kind: Rule
          match: Host(`emby.example.com`)
          services:
              - kind: Service
                name: emby
                namespace: emby
                port: 8080
                scheme: http
                strategy: RoundRobin
                weight: 10
```

如果 href 属性不存在，Homepage 将忽略该特定的 IngressRoute。

## 注意事项

与 Docker 服务发现类似，目前没有严格的顺序来发现服务，并且发现的服务将显示在`services.yaml`中指定的服务之上。