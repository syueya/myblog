
一个AI模型聚合管理中转分发系统。

官方网址：https://github.com/QuantumNous/new-api
参考文档：https://docs.newapi.pro/zh/docs

## 容器部署


注意：
- 默认使用SQLite数据库，如果需要使用远程数据库，请自行修改配置。
- 如果使用本地数据库SQLite，需挂载 /data 目录。
- 如果使用远程数据库，需要MySQL ≥ 5.7.8 或 PostgreSQL ≥ 9.6。

```
services:
  new-api:
    image: calciumion/new-api:latest
    container_name: new-api
    restart: always
    command: --log-dir /app/logs
    ports:
      - 3007:3000
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    environment:
    # - SQL_DSN=postgresql://root:123456@192.168.31.15:5432/newapidb # 如果使用postgresql数据库
    # - SQL_DSN=root:123456@tcp(192.168.31.15:3306)/newapidb  # 如果使用mysql数据库
      - REDIS_CONN_STRING=redis://192.168.31.15:6379
      - PORT=3000
      - TZ=Asia/Shanghai
      - ERROR_LOG_ENABLED=true # 是否启用错误日志记录
      - BATCH_UPDATE_ENABLED=true # 是否启用批量更新
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
```


## 配置newapi

1、打开浏览器，输入IP:端口，进入newapi配置页。如果你的数据库检查没有错误，点击下一步
![img](./img/newapi-01.png)

2、填写管理员账号和密码，点击下一步
![img](./img/newapi-02.png)

3、选择使用模式，点击下一步
![img](./img/newapi-03.png)

4、点击初始化系统
![img](./img/newapi-04.png)

5、初始化后点击右上角的登陆，输入账号密码进入首页。

![img](./img/newapi-05.png)


6、进入首页
![img](./img/newapi-06.png)



## 配置渠道

1、点击添加渠道
![img](./img/newapi-07.png)



2、开始创建新渠道

1）来源

类型默认是OpenAI格式。名称随意，密钥和API地址要填对应的
![img](./img/newapi-08.png)


>注意：使用默认OpenAI格式，API地址不要带`/v1/chat/completions`，它会自动补全。或者你也可以使用#号放在最后面来禁止自动补全。
>- 正常：`https://tbai.xin`
>- 或者：`https://tbai.xin/v1/chat/completions#`


2）填写模型

- 点击获取模型列表，获取不了的前面配置肯定有错误。
- 点击复制所有模型，按照下面的重定向规则获取重定向模型
- 点击清除所有模型，在自定义模型名称里面输入重定向后的模型名称，点击填入
- 测试模型可以不用管，也可以复制一个快速便宜的模型，不过要注意，测试模型要填写重定向后的模型名称
- 在模型重定向里点击手动编辑，把生成的json文本复制进去

![img](./img/newapi-09.png)

3）其他

- 分组自己用的话随便
- 标签随意，只是填写的话开启标签聚合可以更加直观，另外这个标签只在渠道上自己可以看到，别人看不到的
- 可以把自动禁用关闭，避免误判
![img](./img/newapi-10.png)


4）然后提交即可，渠道就添加完成了


### 模型重定向规则

规则：
- 识别模型名的厂商归属，比如`通义千问-xxx`是Qwen
- 去掉模型名里的日期或多余后缀，只保留主模型名，如 claude-3-5-haiku-20241022，不要 20241022是claude-3-5-haiku。允许多个原模型映射到同一标准名。
- 按照“厂商/标准模型名”格式重定向名称，左边为重定向后的名称，右边为原来名称。

厂商列表严格使用英文，如 智谱 → ChatGLM、千问 → Qwen、腾讯混元 → Hunyuan。列表包括不限于：
- Anthropic
- OpenAI
- Gemini
- Moonshot
- ChatGLM
- Qwen
- DeepSeek
- Hunyuan
- MistralAI
- xAI
- Llama
- penAl

模型重定向示例：
```
{
  "Anthropic/claude-3.5-haiku": "claude-3-5-haiku-20241022",
  "智谱/GLM-4.5-air": "BigModel/GLM-4.5-air",
  "Gemini/Gemini-xxx": "Gemini-xxx",
  "智谱/智谱-xxx": "智谱-xxx",
  "通义千问/通义千问-xxx": "通义千问-xxx",
  "DeepSeek/DeepSeek-xxx": "DeepSeek-xxx",
  "腾讯混元/腾讯混元-xxx": "腾讯混元-xxx",
  "Llama/Llama-xxx": "Llama-xxx"
}
```
重定向后的模型名，即左边部分的名称：

```
Anthropic/claude-3.5-haiku,智谱/GLM-4.5-air,Gemini/Gemini-xxx,智谱/智谱-xxx,通义千问/通义千问-xxx,DeepSeek/DeepSeek-xxx,腾讯混元/腾讯混元-xxx,Llama/Llama-xxx
```



## 模型管理


1、先添加一个提供商，图标可以点击下面的链接查看厂商logo对应的名称

![img](./img/newapi-11.png)

2、然后点击未配置模型 ，找到刚刚添加的任意一个模型，点击配置

![img](./img/newapi-12.png)


3、名称里把/后面的模型名称内容删了，仅保留重定向模型添加的厂商部分。名称匹配类型选择前缀名称匹配。图标和描述喜欢的可以去配置一下，标签可以随便添加。然后点击提交即可

![img](./img/newapi-13.png)





## 设置

1、配置倍率

开自用模式的不用看，有强迫症可以看，让你的数据更加直观。按照图片找到未配置的模型，可以使用批量设置。

![img](./img/newapi-14.png)

可以设置固定价格为1。
![img](./img/newapi-15.png)

