## 介绍

Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，您可以使用一个单独的 docker-compose.yml 模板文件来定义一组相关联的应用容器为一个项目。



当然，如果想使用compose的话，你得先进行安装compose，安装命令：
```
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
```

记得赋予可执行权限：`sudo chmod +x /usr/local/bin/docker-compose`

安装完成后可以使用`docker compose version`测试是否已经安装成功。然后可以使用`docker compose --help`查看所有可用的 Docker Compose 命令。

>- 如果你安装的是Docker Compose V1版本，命令格式为 docker-compose（连字符形式），比如 `docker-compose --version`。
>- 如果安装的是 Docker Compose V2，命令格式为 docker compose（空格形式），比如 `docker compose version`。
>- 部分系统可能同时存在两个版本，此时需注意区分（通常新版优先级更高）。

当然对我们来说也不用关注这些，只需要在docker应用里创建项目编写compose模板文件即可。

![img](./img/compose-01.png)


## compose 模板文件

compose模板文件具体的说明可以查看文档：https://docs.docker.com/reference/compose-file/。

一般来说，模板文件一共有以下几个顶级字段:
- 版本(version)和名称(name)：可选，其中版本字段已经过时
- 服务(services)：核心字段，定义所有服务（每个服务对应一个或多个容器）
- 网络(networks)：可选，默认会创建一个桥接网络
- 数据卷(volumes)：可选，用于持久化数据
- 配置文件(configs)：可选，用于共享配置
- 敏感信息(secrets)：可选，如密码、证书

在这几个顶级字段里，我们一般用的都是服务(services)字段。当然，服务字段也有很多属性，我们也不一一讲解，具体的可以看[服务属性](https://docs.docker.com/reference/compose-file/services/#attributes)。

下面来介绍一下常用的属性：


### image

指定容器使用的镜像与版本，如果没有指定版本，一般默认是最新版本。比如：
```
image: whyour/qinglong:latest
image: linuxserver/qbittorrent:4.6.7
```

### container_name

指定通过compose文件部署后的容器名称，不指定则会默认生成一个名称，默认的名称格式为：项目名_服务名_序号
>注意：指定的容器名称必须是唯一的，如果尝试创建两个相同名称的容器，Docker 将会报错。

### restart

restart 定义了容器重启策略，一般不指定的话默认是no：
- no ：退出后不会重启容器。
- always ：无论容器以何种原因退出（包括正常退出、错误退出），Docker 都会自动重启容器。
- unless-stopped ：除非手动停止容器（docker stop），否则无论容器如何退出，都会自动重启。
- on-failure[:max-retries] ：仅当容器以非 0 状态码退出（即异常退出）时，才自动重启。
  - 可选参数 max-retries：限制最大重启次数（如 on-failure:3 表示最多重启 3 次，超过后停止尝试）。


### networks

指定启动容器时使用的网络（需在 networks 字段中定义）



### network_mode


none ：关闭所有容器网络。
host ：为容器提供对主机网络接口的原始访问权限。
service:{name} ：通过引用其服务名称授予容器对指定容器的访问权限。
container:{name} ：通过引用容器 ID 授予容器对指定容器的访问权限。
设置后，不允许使用 networks 属性，并且 Compose 会拒绝任何同时包含这两个属性的 Compose 文件。
### ports

端口映射，格式 [宿主机端口:容器端口]（如 8080:80）


### volumes

目录映射，格式 [宿主机路径:容器路径:权限]（如 ./data:/app/data:ro）


### environment

环境变量，可直接写键值对或引用 .env 文件


### depends_on

解决容器的依赖、启动先后的问题


### command

使用command会覆盖镜像启动后要默认执行的命令


privileged: true  # 特权模式
    deploy:  
      resources:  
        limits:  
          cpus: '4'   # 限制容器可以使用的最大CPU核心数 
          memory: 4G  # 限制容器可以使用的最大内存量
        # reservations:  
        #   cpus: '2'   # 保证容器至少可以使用的CPU核心数
        #   memory: 2G  # 保证容器至少可以使用的内存量