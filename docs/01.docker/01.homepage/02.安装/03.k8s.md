---
title: k8s
permalink: /docker/homepage/install/k8s
date: 2023-10-24 14:23:11
categories: 
  - docker教程
  - homepage
  - 安装
tags: 
  - 
---

## 使用Helm安装

有一个非官方的 [Helm Chart](https://github.com/jameswynn/helm-charts/tree/main/charts/homepage)，它可以创建所有必需的清单文件，包括用于服务发现所需的服务账号和 RBAC 实体。

```sh
helm repo add jameswynn https://jameswynn.github.io/helm-charts
helm install 01.homepage jameswynn/01.homepage -f values.yaml
```
这个 Helm Chart 允许将所有的配置直接内嵌在`values.yaml`文件中。

```yaml
config:
    bookmarks:
        - Developer:
              - Github:
                    - abbr: GH
                      href: https://github.com/
    services:
        - My First Group:
              - My First Service:
                    href: http://localhost/
                    description: Homepage is awesome

        - My Second Group:
              - My Second Service:
                    href: http://localhost/
                    description: Homepage is the best

        - My Third Group:
              - My Third Service:
                    href: http://localhost/
                    description: Homepage is 😎
    widgets:
        # show the kubernetes widget, with the cluster summary and individual nodes
        - kubernetes:
              cluster:
                  show: true
                  cpu: true
                  memory: true
                  showLabel: true
                  label: "cluster"
              nodes:
                  show: true
                  cpu: true
                  memory: true
                  showLabel: true
        - search:
              provider: duckduckgo
              target: _blank
    kubernetes:
        mode: cluster
    settings:

# The service account is necessary to allow discovery of other services
serviceAccount:
    create: true
    name: 01.homepage

# This enables the service account to access the necessary resources
enableRbac: true

ingress:
    main:
        enabled: true
        annotations:
            # Example annotations to add Homepage to your Homepage!
            gethomepage.dev/enabled: "true"
            gethomepage.dev/name: "Homepage"
            gethomepage.dev/description: "Dynamically Detected Homepage"
            gethomepage.dev/group: "Dynamic"
            gethomepage.dev/icon: "01.homepage.png"
        hosts:
            - host: 01.homepage.example.com
              paths:
                  - path: /
                    pathType: Prefix
```

## 使用Kubernetes Manifests安装

如果您不想使用非官方的 Helm Chart，您也可以自己创建 Kubernetes 清单文件，并使用 kubectl apply -f filename.yaml 命令应用它们。

下面是一个示例，展示了您所需的资源的工作方式：

#### 服务账号 ServiceAccount

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
secrets:
    - name: 01.homepage
```

#### Secret

```yaml
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
    annotations:
        kubernetes.io/service-account.name: 01.homepage
```

#### 配置映射 ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
data:
    kubernetes.yaml: |
        mode: cluster
    settings.yaml: ""
    #settings.yaml: |
    #  providers:
    #    longhorn:
    #      url: https://longhorn.my.network
    custom.css: ""
    custom.js: ""
    bookmarks.yaml: |
        - Developer:
            - Github:
                - abbr: GH
                  href: https://github.com/
    services.yaml: |
        - My First Group:
            - My First Service:
                href: http://localhost/
                description: Homepage is awesome

        - My Second Group:
            - My Second Service:
                href: http://localhost/
                description: Homepage is the best

        - My Third Group:
            - My Third Service:
                href: http://localhost/
                description: Homepage is 😎
    widgets.yaml: |
        - kubernetes:
            cluster:
              show: true
              cpu: true
              memory: true
              showLabel: true
              label: "cluster"
            nodes:
              show: true
              cpu: true
              memory: true
              showLabel: true
        - resources:
            backend: resources
            expanded: true
            cpu: true
            memory: true
        - search:
            provider: duckduckgo
            target: _blank
    docker.yaml: ""
```

#### 集群角色和集群角色绑定 ClusterRole and ClusterRoleBinding

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
    name: 01.homepage
    labels:
        app.kubernetes.io/name: 01.homepage
rules:
    - apiGroups:
          - ""
      resources:
          - namespaces
          - pods
          - nodes
      verbs:
          - get
          - list
    - apiGroups:
          - extensions
          - networking.k8s.io
      resources:
          - ingresses
      verbs:
          - get
          - list
    - apiGroups:
          - traefik.containo.us
      resources:
          - ingressroutes
      verbs:
          - get
          - list
    - apiGroups:
          - metrics.k8s.io
      resources:
          - nodes
          - pods
      verbs:
          - get
          - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
    name: 01.homepage
    labels:
        app.kubernetes.io/name: 01.homepage
roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: 01.homepage
subjects:
    - kind: ServiceAccount
      name: 01.homepage
      namespace: default
```

#### Service

```yaml
apiVersion: v1
kind: Service
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
    annotations:
spec:
    type: ClusterIP
    ports:
        - port: 3000
          targetPort: http
          protocol: TCP
          name: http
    selector:
        app.kubernetes.io/name: 01.homepage
```

#### 部署 Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
spec:
    revisionHistoryLimit: 3
    replicas: 1
    strategy:
        type: RollingUpdate
    selector:
        matchLabels:
            app.kubernetes.io/name: 01.homepage
    template:
        metadata:
            labels:
                app.kubernetes.io/name: 01.homepage
        spec:
            serviceAccountName: 01.homepage
            automountServiceAccountToken: true
            dnsPolicy: ClusterFirst
            enableServiceLinks: true
            containers:
                - name: 01.homepage
                  image: "ghcr.io/gethomepage/01.homepage:latest"
                  imagePullPolicy: Always
                  ports:
                      - name: http
                        containerPort: 3000
                        protocol: TCP
                  volumeMounts:
                      - mountPath: /app/config/custom.js
                        name: 01.homepage-config
                        subPath: custom.js
                      - mountPath: /app/config/custom.css
                        name: 01.homepage-config
                        subPath: custom.css
                      - mountPath: /app/config/bookmarks.yaml
                        name: 01.homepage-config
                        subPath: bookmarks.yaml
                      - mountPath: /app/config/docker.yaml
                        name: 01.homepage-config
                        subPath: docker.yaml
                      - mountPath: /app/config/kubernetes.yaml
                        name: 01.homepage-config
                        subPath: kubernetes.yaml
                      - mountPath: /app/config/services.yaml
                        name: 01.homepage-config
                        subPath: services.yaml
                      - mountPath: /app/config/settings.yaml
                        name: 01.homepage-config
                        subPath: settings.yaml
                      - mountPath: /app/config/widgets.yaml
                        name: 01.homepage-config
                        subPath: widgets.yaml
                      - mountPath: /app/config/logs
                        name: logs
            volumes:
                - name: 01.homepage-config
                  configMap:
                      name: 01.homepage
                - name: logs
                  emptyDir: {}
```

#### Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: 01.homepage
    namespace: default
    labels:
        app.kubernetes.io/name: 01.homepage
    annotations:
        gethomepage.dev/description: Dynamically Detected Homepage
        gethomepage.dev/enabled: "true"
        gethomepage.dev/group: Cluster Management
        gethomepage.dev/icon: 01.homepage.png
        gethomepage.dev/name: Homepage
spec:
    rules:
        - host: "01.homepage.my.network"
          http:
              paths:
                  - path: "/"
                    pathType: Prefix
                    backend:
                        service:
                            name: 01.homepage
                            port:
                                number: 3000
```
